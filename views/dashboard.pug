doctype
html(lang='ar' dir='rtl')
    head
        meta(charset='utf-8')
        meta(name='viewport', content='width=device-width, initial-scale=1.0')
        title لوحة تحكم واتساب
        link(rel='stylesheet', href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css')
        style.
            :root {
                --primary-color: #128C7E;
                --secondary-color: #25D366;
                --dark-color: #075E54;
                --light-color: #DCF8C6;
                --accent-color: #34B7F1;
                --text-color: #333;
                --border-radius: 12px;
                --shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            }
            
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                font-family: 'Cairo', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            }
            
            body {
                background-color: #f5f5f5;
                color: var(--text-color);
                direction: rtl;
            }
            
            /* لوحة تحكم رئيسية */
            .dashboard {
                padding: 0;
                display: flex;
                min-height: 100vh;
            }
            
            /* شريط جانبي */
            .sidebar {
                width: 280px;
                background: linear-gradient(45deg, var(--dark-color), var(--primary-color));
                color: white;
                padding: 20px;
                border-radius: 0 var(--border-radius) var(--border-radius) 0;
                box-shadow: var(--shadow);
                display: flex;
                flex-direction: column;
                position: fixed;
                height: 100%;
                overflow-y: auto;
            }
            
            .sidebar-header {
                margin-bottom: 30px;
                text-align: center;
            }
            
            .sidebar-header h2 {
                font-size: 24px;
                margin: 10px 0;
            }
            
            .profile-info {
                display: flex;
                flex-direction: column;
                align-items: center;
                margin-bottom: 20px;
            }
            
            .profile-pic {
                width: 80px;
                height: 80px;
                border-radius: 50%;
                object-fit: cover;
                border: 3px solid white;
                background-color: #e0e0e0;
                display: flex;
                align-items: center;
                justify-content: center;
                margin-bottom: 10px;
            }
            
            .profile-pic img {
                width: 100%;
                height: 100%;
                border-radius: 50%;
                object-fit: cover;
            }
            
            .profile-pic i {
                font-size: 40px;
                color: #888;
            }
            
            .nav-menu {
                list-style: none;
                margin-top: 20px;
            }
            
            .nav-item {
                padding: 12px 15px;
                margin-bottom: 5px;
                border-radius: var(--border-radius);
                transition: all 0.3s ease;
                cursor: pointer;
            }
            
            .nav-item.active, .nav-item:hover {
                background-color: rgba(255, 255, 255, 0.2);
            }
            
            .nav-item i {
                margin-left: 10px;
                width: 20px;
                text-align: center;
            }
            
            /* المحتوى الرئيسي */
            .main-content {
                flex: 1;
                padding: 20px;
                margin-right: 280px;
                overflow-x: hidden;
            }
            
            /* شريط علوي */
            .top-bar {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 30px;
                padding: 15px 20px;
                background-color: white;
                border-radius: var(--border-radius);
                box-shadow: var(--shadow);
            }
            
            .connection-status {
                display: flex;
                align-items: center;
                font-weight: bold;
            }
            
            .status-indicator {
                width: 12px;
                height: 12px;
                border-radius: 50%;
                margin-left: 8px;
            }
            
            .status-indicator.online {
                background-color: var(--secondary-color);
                box-shadow: 0 0 8px var(--secondary-color);
            }
            
            .status-indicator.offline {
                background-color: #f44336;
                box-shadow: 0 0 8px #f44336;
            }
            
            .status-indicator.connecting {
                background-color: #FFC107;
                box-shadow: 0 0 8px #FFC107;
            }
            
            .search-box {
                display: flex;
                align-items: center;
                background-color: #f5f5f5;
                border-radius: 50px;
                padding: 8px 15px;
                width: 300px;
            }
            
            .search-box input {
                background: transparent;
                border: none;
                outline: none;
                width: 100%;
                padding: 5px;
                font-size: 14px;
            }
            
            .search-box i {
                color: #888;
                margin-left: 8px;
            }
            
            /* البطاقات الإحصائية */
            .stats-cards {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }
            
            .stat-card {
                background-color: white;
                border-radius: var(--border-radius);
                padding: 20px;
                box-shadow: var(--shadow);
                transition: transform 0.3s ease;
            }
            
            .stat-card:hover {
                transform: translateY(-5px);
            }
            
            .stat-card .card-icon {
                width: 60px;
                height: 60px;
                border-radius: 50%;
                background-color: var(--light-color);
                display: flex;
                align-items: center;
                justify-content: center;
                margin-bottom: 15px;
            }
            
            .stat-card .card-icon i {
                font-size: 24px;
                color: var(--primary-color);
            }
            
            .stat-card h3 {
                font-size: 30px;
                margin: 10px 0;
            }
            
            .stat-card p {
                color: #888;
                font-size: 14px;
            }
            
            /* الأقسام */
            .section {
                background-color: white;
                border-radius: var(--border-radius);
                padding: 25px;
                margin-bottom: 30px;
                box-shadow: var(--shadow);
            }
            
            .section-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
                padding-bottom: 10px;
                border-bottom: 1px solid #eee;
            }
            
            .section-title {
                font-size: 18px;
                font-weight: bold;
                color: var(--primary-color);
            }
            
            .section-action {
                color: var(--primary-color);
                font-size: 14px;
                cursor: pointer;
            }
            
            /* جدول المستخدمين */
            .data-table {
                width: 100%;
                border-collapse: collapse;
            }
            
            .data-table th,
            .data-table td {
                padding: 12px 15px;
                text-align: right;
            }
            
            .data-table th {
                background-color: rgba(18, 140, 126, 0.1);
                color: var(--primary-color);
                font-weight: bold;
                position: sticky;
                top: 0;
            }
            
            .data-table tbody tr {
                border-bottom: 1px solid #eee;
                transition: background-color 0.3s ease;
            }
            
            .data-table tbody tr:last-child {
                border-bottom: none;
            }
            
            .data-table tbody tr:hover {
                background-color: rgba(18, 140, 126, 0.05);
            }
            
            .user-cell {
                display: flex;
                align-items: center;
            }
            
            .user-avatar {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                overflow: hidden;
                margin-left: 10px;
                background-color: #e0e0e0;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .user-avatar img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }
            
            .user-avatar i {
                font-size: 20px;
                color: #888;
            }
            
            .user-info {
                display: flex;
                flex-direction: column;
            }
            
            .user-name {
                font-weight: bold;
            }
            
            .user-number {
                color: #888;
                font-size: 12px;
            }
            
            .badge {
                display: inline-block;
                padding: 4px 10px;
                border-radius: 50px;
                font-size: 12px;
                font-weight: bold;
            }
            
            .badge-group {
                background-color: #e91e63;
                color: white;
            }
            
            .badge-contact {
                background-color: var(--accent-color);
                color: white;
            }
            
            .action-buttons {
                display: flex;
                gap: 5px;
            }
            
            .btn-action {
                background-color: #f5f5f5;
                border: none;
                border-radius: 50%;
                width: 35px;
                height: 35px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: all 0.3s ease;
            }
            
            .btn-action:hover {
                background-color: var(--light-color);
                color: var(--primary-color);
            }
            
            /* قسم المحادثات الأخيرة */
            .chat-list {
                margin-top: 20px;
            }
            
            .chat-item {
                display: flex;
                padding: 15px;
                border-radius: var(--border-radius);
                margin-bottom: 10px;
                transition: all 0.3s ease;
                border-bottom: 1px solid #eee;
            }
            
            .chat-item:last-child {
                border-bottom: none;
            }
            
            .chat-item:hover {
                background-color: rgba(18, 140, 126, 0.05);
            }
            
            .chat-avatar {
                width: 50px;
                height: 50px;
                border-radius: 50%;
                margin-left: 15px;
                overflow: hidden;
                background-color: #e0e0e0;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .chat-avatar img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }
            
            .chat-avatar i {
                font-size: 25px;
                color: #888;
            }
            
            .chat-content {
                flex: 1;
            }
            
            .chat-header {
                display: flex;
                justify-content: space-between;
                margin-bottom: 5px;
            }
            
            .chat-name {
                font-weight: bold;
            }
            
            .chat-time {
                color: #888;
                font-size: 12px;
            }
            
            .chat-message {
                color: #666;
                font-size: 14px;
                max-width: 80%;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            
            .unread-count {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 25px;
                height: 25px;
                background-color: var(--primary-color);
                color: white;
                border-radius: 50%;
                font-size: 12px;
                font-weight: bold;
            }
            
            /* قسم الرسائل الأخيرة */
            .message-list {
                margin-top: 20px;
            }
            
            .message-item {
                padding: 15px;
                border-radius: var(--border-radius);
                margin-bottom: 10px;
                transition: all 0.3s ease;
                border-bottom: 1px solid #eee;
            }
            
            .message-item:last-child {
                border-bottom: none;
            }
            
            .message-item:hover {
                background-color: rgba(18, 140, 126, 0.05);
            }
            
            .message-header {
                display: flex;
                justify-content: space-between;
                margin-bottom: 8px;
                align-items: center;
            }
            
            .message-sender {
                font-weight: bold;
                display: flex;
                align-items: center;
            }
            
            .sender-avatar {
                width: 30px;
                height: 30px;
                border-radius: 50%;
                margin-left: 10px;
                overflow: hidden;
                background-color: #e0e0e0;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .sender-avatar img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }
            
            .message-chat {
                display: flex;
                align-items: center;
                color: #888;
                font-size: 12px;
            }
            
            .message-content {
                background-color: var(--light-color);
                padding: 10px 15px;
                border-radius: var(--border-radius);
                display: inline-block;
                max-width: 80%;
                word-break: break-word;
            }
            
            .message-content.outgoing {
                background-color: var(--accent-color);
                color: white;
            }
            
            .loading-panel {
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100%;
                padding: 50px;
            }
            
            .loader {
                border: 5px solid #f3f3f3;
                border-radius: 50%;
                border-top: 5px solid var(--primary-color);
                width: 50px;
                height: 50px;
                animation: spin 1s linear infinite;
            }
            
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            
            /* للشاشات الصغيرة */
            @media screen and (max-width: 768px) {
                .dashboard {
                    flex-direction: column;
                }
                
                .sidebar {
                    width: 100%;
                    position: relative;
                    border-radius: 0;
                    height: auto;
                }
                
                .main-content {
                    margin-right: 0;
                    padding: 15px;
                }
                
                .stats-cards {
                    grid-template-columns: 1fr;
                }
                
                .top-bar {
                    flex-direction: column;
                    gap: 10px;
                }
                
                .search-box {
                    width: 100%;
                }
            }
    body
        span(style="display:none;", id="clientready")=clientready
        span(style="display:none;", id="clientauthenticated")=clientauthenticated
        
        div(class="dashboard")
            div(class="sidebar")
                div(class="sidebar-header")
                    h2 بوت واتساب
                
                div(class="profile-info")
                    div(class="profile-pic" id="profile-pic")
                        i(class="fas fa-user")
                    div(class="profile-name" id="profile-name") جاري تحميل المعلومات...
                
                ul(class="nav-menu")
                    li(class="nav-item active" data-section="general")
                        i(class="fas fa-home")
                        span لوحة القيادة
                    li(class="nav-item" data-section="contacts")
                        i(class="fas fa-address-book")
                        span جهات الاتصال
                    li(class="nav-item" data-section="chats")
                        i(class="fas fa-comments")
                        span المحادثات
                    li(class="nav-item" data-section="messages")
                        i(class="fas fa-envelope")
                        span الرسائل الأخيرة
                    li(class="nav-item")
                        a(href="/api/keys-management", style="text-decoration: none; color: inherit;")
                            i(class="fas fa-key")
                            span إدارة مفاتيح API
                    
            div(class="main-content")
                div(class="top-bar")
                    div(class="connection-status" id="connection-status")
                        div(class="status-indicator")
                        span جاري التحميل...
                    
                    div(class="search-box")
                        i(class="fas fa-search")
                        input(type="text", placeholder="بحث...")
                
                div(class="section-container" id="general-section")
                    div(class="stats-cards")
                        div(class="stat-card")
                            div(class="card-icon")
                                i(class="fas fa-users")
                            p عدد جهات الاتصال
                            h3(id="contacts-count") -
                            
                        div(class="stat-card")
                            div(class="card-icon")
                                i(class="fas fa-comments")
                            p عدد المحادثات
                            h3(id="chats-count") -
                            
                        div(class="stat-card")
                            div(class="card-icon")
                                i(class="fas fa-clock")
                            p وقت الاتصال
                            h3(id="connected-time") -
                            
                        div(class="stat-card")
                            div(class="card-icon")
                                i(class="fas fa-mobile-alt")
                            p النظام
                            h3(id="platform") -
                            
                    div(class="section")
                        div(class="section-header")
                            h3(class="section-title") آخر المحادثات
                            span(class="section-action") عرض الكل
                        
                        div(class="chat-list" id="recent-chats-list")
                            div(class="loading-panel")
                                div(class="loader")
                                
                    div(class="section")
                        div(class="section-header")
                            h3(class="section-title") آخر الرسائل
                            span(class="section-action") عرض الكل
                        
                        div(class="message-list" id="recent-messages-list")
                            div(class="loading-panel")
                                div(class="loader")
                
                div(class="section-container" id="contacts-section" style="display: none;")
                    div(class="section")
                        div(class="section-header")
                            h3(class="section-title") جهات الاتصال
                            span(class="section-action") تحديث
                        
                        div(class="table-container")
                            table(class="data-table" id="contacts-table")
                                thead
                                    tr
                                        th جهة الاتصال
                                        th رقم الهاتف
                                        th النوع
                                        th الإجراءات
                                tbody
                                    tr
                                        td(colspan="4") 
                                            div(class="loading-panel")
                                                div(class="loader")
                
                div(class="section-container" id="chats-section" style="display: none;")
                    div(class="section")
                        div(class="section-header")
                            h3(class="section-title") المحادثات
                            span(class="section-action") تحديث
                        
                        div(class="chat-list" id="chats-list")
                            div(class="loading-panel")
                                div(class="loader")
                
                div(class="section-container" id="messages-section" style="display: none;")
                    div(class="section")
                        div(class="section-header")
                            h3(class="section-title") الرسائل الأخيرة
                            span(class="section-action") تحديث
                        
                        div(class="message-list" id="messages-list")
                            div(class="loading-panel")
                                div(class="loader")
                
        script.
            // تعريفات الدوال المساعدة على المستوى العالمي
            // دالة تنسيق التاريخ
            function formatDate(timestamp) {
                if (!timestamp) return '-';
                
                const date = new Date(timestamp * 1000);
                const now = new Date();
                const diffInHours = (now - date) / (1000 * 60 * 60);
                
                if (diffInHours < 24) {
                    // اليوم - عرض الساعة فقط
                    return date.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
                } else if (diffInHours < 48) {
                    // الأمس
                    return 'أمس';
                } else {
                    // عرض التاريخ
                    return date.toLocaleDateString('ar-SA', { year: 'numeric', month: 'short', day: 'numeric' });
                }
            }
            
            // دالة تنسيق اسم المستخدم
            function formatUserName(name, isGroup) {
                if (!name) return 'غير معروف';
                
                if (isGroup) {
                    return name;
                } else {
                    // تحويل أرقام الهواتف إلى تنسيق أفضل
                    if (/^\d+$/.test(name)) {
                        // إذا كان الاسم أرقام فقط، افترض أنه رقم هاتف
                        return name.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
                    }
                    return name;
                }
            }

            // إعلان دالة fetchDashboardData كمتغير عام
            let dashboardData = null;
            
            // دالة بناء جدول جهات الاتصال
            window.buildContactsTable = function(contacts) {
                const tableBody = document.querySelector('#contacts-table tbody');
                tableBody.innerHTML = '';
                
                if (!contacts || contacts.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="4" style="text-align: center;">لا توجد جهات اتصال</td>`;
                    tableBody.appendChild(row);
                    return;
                }
                
                contacts.forEach(contact => {
                    const row = document.createElement('tr');
                    
                    // التحقق من البيانات قبل استخدامها
                    let name = 'غير معروف';
                    if (contact.name) {
                        name = contact.name;
                    } else if (contact.number) {
                        name = contact.number;
                    }

                    let number = contact.number || 'غير معروف';
                    
                    const userCell = `
                        <td>
                            <div class="user-cell">
                                <div class="user-avatar">
                                    ${contact.profilePic ? `<img src="${contact.profilePic}" alt="صورة المستخدم">` : '<i class="fas fa-user"></i>'}
                                </div>
                                <div class="user-info">
                                    <div class="user-name">${formatUserName(name, contact.isGroup)}</div>
                                    <div class="user-number">${number}</div>
                                </div>
                            </div>
                        </td>
                    `;
                    
                    const phoneCell = `<td>${number}</td>`;
                    const typeCell = `<td><span class="badge ${contact.isGroup ? 'badge-group' : 'badge-contact'}">${contact.isGroup ? 'مجموعة' : 'جهة اتصال'}</span></td>`;
                    const actionsCell = `
                        <td>
                            <div class="action-buttons">
                                <button class="btn-action" title="رسالة جديدة" onclick="window.open('/api/v1/qr', '_blank')"><i class="fas fa-paper-plane"></i></button>
                                <button class="btn-action" title="عرض المعلومات"><i class="fas fa-info-circle"></i></button>
                            </div>
                        </td>
                    `;
                    
                    row.innerHTML = userCell + phoneCell + typeCell + actionsCell;
                    tableBody.appendChild(row);
                });
            };
            
            // دالة بناء قائمة المحادثات
            window.buildChatsList = function(chats, elementId) {
                const chatsList = document.getElementById(elementId);
                chatsList.innerHTML = '';
                
                if (!chats || chats.length === 0) {
                    chatsList.innerHTML = '<div style="text-align: center; padding: 20px;">لا توجد محادثات</div>';
                    return;
                }
                
                chats.forEach(chat => {
                    const chatItem = document.createElement('div');
                    chatItem.className = 'chat-item';
                    
                    // تنسيق أخر رسالة والوقت
                    let lastMessage = 'لا توجد رسائل';
                    let lastTime = '';
                    
                    if (chat.lastMessage) {
                        if (typeof chat.lastMessage === 'object') {
                            lastMessage = chat.lastMessage.body || 'ملف وسائط';
                            lastTime = formatDate(chat.lastMessage.timestamp) || '';
                        } else {
                            lastMessage = chat.lastMessage.toString() || 'ملف وسائط';
                        }
                    }
                    
                    // التحقق من وجود اسم المحادثة
                    let chatName = 'محادثة';
                    if (chat.name) {
                        chatName = chat.name;
                    } else if (chat.id && typeof chat.id === 'string') {
                        // استخراج الرقم من ID المحادثة إن أمكن
                        const match = chat.id.match(/(\d+)@/);
                        if (match && match[1]) {
                            chatName = match[1];
                        }
                    }
                    
                    // بناء عنصر المحادثة
                    chatItem.innerHTML = `
                        <div class="chat-avatar">
                            <i class="${chat.isGroup ? 'fas fa-users' : 'fas fa-user'}"></i>
                        </div>
                        <div class="chat-content">
                            <div class="chat-header">
                                <div class="chat-name">${formatUserName(chatName, chat.isGroup)}</div>
                                <div class="chat-time">${lastTime}</div>
                            </div>
                            <div class="chat-message">${lastMessage}</div>
                        </div>
                        ${chat.unreadCount ? `<div class="unread-count">${chat.unreadCount}</div>` : ''}
                    `;
                    
                    chatsList.appendChild(chatItem);
                });
            };
            
            // دالة بناء قائمة الرسائل
            window.buildMessagesList = function(messages, elementId) {
                const messagesList = document.getElementById(elementId);
                messagesList.innerHTML = '';
                
                if (!messages || messages.length === 0) {
                    messagesList.innerHTML = '<div style="text-align: center; padding: 20px;">لا توجد رسائل</div>';
                    return;
                }
                
                messages.forEach(msg => {
                    const messageItem = document.createElement('div');
                    messageItem.className = 'message-item';
                    
                    // التحقق من وجود البيانات
                    const sender = msg.sender || 'غير معروف';
                    const chatName = msg.chatName || 'محادثة';
                    const messageText = msg.message || (msg.body || 'ملف وسائط');
                    const timestamp = msg.timestamp ? formatDate(msg.timestamp) : '';
                    const isFromMe = msg.fromMe || false;
                    
                    messageItem.innerHTML = `
                        <div class="message-header">
                            <div class="message-sender">
                                <div class="sender-avatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                ${sender}
                            </div>
                            <div class="message-chat">
                                <i class="fas fa-comment-alt" style="margin-left: 5px;"></i>
                                ${chatName}
                                <span style="margin-right: 10px;">${timestamp}</span>
                            </div>
                        </div>
                        <div class="message-content ${isFromMe ? 'outgoing' : ''}">
                            ${messageText}
                        </div>
                    `;
                    
                    messagesList.appendChild(messageItem);
                });
            };
            
            // دالة تحديث واجهة لوحة التحكم
            window.updateDashboard = function() {
                if (!dashboardData) {
                    console.error("لا توجد بيانات لعرضها");
                    return;
                }
                
                console.log("تحديث الداشبورد بالبيانات:", dashboardData);
                
                // تحديث معلومات الملف الشخصي
                const profilePic = document.getElementById('profile-pic');
                const profileName = document.getElementById('profile-name');
                
                // التحقق من وجود بيانات الحساب
                if (dashboardData.account && dashboardData.account.profilePic) {
                    profilePic.innerHTML = `<img src="${dashboardData.account.profilePic}" alt="الصورة الشخصية">`;
                } else {
                    profilePic.innerHTML = `<i class="fas fa-user"></i>`;
                }
                
                if (dashboardData.account && dashboardData.account.phoneNumber) {
                    profileName.textContent = dashboardData.account.phoneNumber || 'غير معروف';
                } else {
                    profileName.textContent = 'حساب واتساب متصل';
                }
                
                // تحديث البطاقات الإحصائية
                if (dashboardData.stats) {
                    document.getElementById('contacts-count').textContent = dashboardData.stats.contactsCount || 0;
                    document.getElementById('chats-count').textContent = dashboardData.stats.chatsCount || 0;
                    document.getElementById('platform').textContent = dashboardData.stats.platform || 'واتساب';
                
                    // تنسيق وقت الاتصال
                    if (dashboardData.stats.connectedOn) {
                        const connectedTime = new Date(dashboardData.stats.connectedOn);
                        const now = new Date();
                        const diffInMinutes = Math.floor((now - connectedTime) / 60000);
                        
                        let timeDisplay;
                        if (diffInMinutes < 60) {
                            timeDisplay = `${diffInMinutes} دقيقة`;
                        } else if (diffInMinutes < 1440) {
                            const hours = Math.floor(diffInMinutes / 60);
                            timeDisplay = `${hours} ساعة`;
                        } else {
                            const days = Math.floor(diffInMinutes / 1440);
                            timeDisplay = `${days} يوم`;
                        }
                        
                        document.getElementById('connected-time').textContent = timeDisplay;
                    } else {
                        document.getElementById('connected-time').textContent = 'للتو';
                    }
                } else {
                    document.getElementById('contacts-count').textContent = '0';
                    document.getElementById('chats-count').textContent = '0';
                    document.getElementById('platform').textContent = 'واتساب';
                    document.getElementById('connected-time').textContent = 'للتو';
                }
                
                // بناء قائمة المحادثات الأخيرة إذا وجدت
                if (dashboardData.chats && dashboardData.chats.length > 0) {
                    window.buildChatsList(dashboardData.chats.slice(0, 5), 'recent-chats-list');
                    window.buildChatsList(dashboardData.chats, 'chats-list');
                } else {
                    document.getElementById('recent-chats-list').innerHTML = '<div style="text-align: center; padding: 20px;">لا توجد محادثات</div>';
                    document.getElementById('chats-list').innerHTML = '<div style="text-align: center; padding: 20px;">لا توجد محادثات</div>';
                }
                
                // بناء قائمة جهات الاتصال إذا وجدت
                if (dashboardData.contacts && dashboardData.contacts.length > 0) {
                    window.buildContactsTable(dashboardData.contacts);
                } else {
                    const tableBody = document.querySelector('#contacts-table tbody');
                    tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">لا توجد جهات اتصال</td></tr>';
                }
                
                // بناء قائمة الرسائل الأخيرة إذا وجدت
                if (dashboardData.recentMessages && dashboardData.recentMessages.length > 0) {
                    window.buildMessagesList(dashboardData.recentMessages.slice(0, 5), 'recent-messages-list');
                    window.buildMessagesList(dashboardData.recentMessages, 'messages-list');
                } else {
                    document.getElementById('recent-messages-list').innerHTML = '<div style="text-align: center; padding: 20px;">لا توجد رسائل حديثة</div>';
                    document.getElementById('messages-list').innerHTML = '<div style="text-align: center; padding: 20px;">لا توجد رسائل</div>';
                }
            };
            
            // تعريف الدالة على المستوى العالمي لنتمكن من استدعائها من الأزرار
            window.fetchDashboardData = async function() {
                try {
                    console.log("بدء طلب بيانات لوحة التحكم...");
                    const response = await fetch('/api/v1/dashboard-data');
                    
                    console.log("استجابة الخادم:", response.status, response.statusText);
                    
                    if (!response.ok) {
                        throw new Error(`فشل في جلب البيانات: ${response.status} ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log("استلام البيانات:", data); // معلومات التصحيح
                    
                    if (data.success) {
                        // التعامل مع تنسيق البيانات الذي يرسله الخادم - قد يكون في data.data أو في حقول مباشرة
                        if (data.data) {
                            // استخدام data.data كما هو متوقع
                            dashboardData = data.data;
                        } else if (data.connectionStatus || data.accountInfo) {
                            // البيانات موجودة في المستوى الرئيسي من الاستجابة
                            dashboardData = {
                                account: {
                                    status: data.connectionStatus,
                                    phoneNumber: data.accountInfo?.me?.id?.replace('@c.us', '') || 'غير متوفر',
                                    profilePic: data.profileUrl
                                },
                                stats: {
                                    contactsCount: data.contactsCount || 0,
                                    chatsCount: data.chatsCount || 0,
                                    activeStatus: data.connectionStatus,
                                    platform: data.accountInfo?.me?.name || 'واتساب',
                                    connectedOn: new Date()
                                },
                                contacts: data.contacts || [],
                                chats: data.chats || [],
                                recentMessages: [] // لا توجد رسائل حالياً
                            };
                        } else {
                            throw new Error("تنسيق البيانات المستلمة غير متوافق");
                        }
                        window.updateDashboard();
                    } else {
                        throw new Error(data.error || 'فشل في جلب البيانات');
                    }
                } catch (error) {
                    console.error('Error fetching dashboard data:', error);
                    // عرض رسالة خطأ للمستخدم
                    document.querySelectorAll('.loading-panel').forEach(panel => {
                        panel.innerHTML = `
                            <div style="text-align: center; color: red;">
                                <p>فشل في تحميل البيانات: ${error.message}</p>
                                <button onclick="window.fetchDashboardData()" style="margin-top: 10px; padding: 5px 15px; background-color: var(--primary-color); color: white; border: none; border-radius: 5px; cursor: pointer;">إعادة المحاولة</button>
                            </div>
                        `;
                    });
                }
            };

            document.addEventListener('DOMContentLoaded', function() {
                // المتغيرات العامة
                const isClientReady = document.getElementById('clientready').textContent.trim() === 'yes';
                const isClientAuthenticated = document.getElementById('clientauthenticated').textContent.trim() === 'yes';
                
                // تحديث حالة الاتصال
                const connectionStatus = document.getElementById('connection-status');
                const statusIndicator = connectionStatus.querySelector('.status-indicator');
                
                if (isClientReady && isClientAuthenticated) {
                    connectionStatus.querySelector('span').textContent = 'متصل';
                    statusIndicator.className = 'status-indicator online';
                } else if (isClientAuthenticated) {
                    connectionStatus.querySelector('span').textContent = 'جاري الاتصال';
                    statusIndicator.className = 'status-indicator connecting';
                } else {
                    connectionStatus.querySelector('span').textContent = 'غير متصل';
                    statusIndicator.className = 'status-indicator offline';
                }
                
                // التنقل بين الأقسام
                const navItems = document.querySelectorAll('.nav-item');
                const sectionContainers = document.querySelectorAll('.section-container');
                
                navItems.forEach(item => {
                    item.addEventListener('click', function() {
                        // إزالة الفئة النشطة من جميع العناصر
                        navItems.forEach(navItem => navItem.classList.remove('active'));
                        
                        // إضافة الفئة النشطة للعنصر المحدد
                        this.classList.add('active');
                        
                        // إخفاء جميع الأقسام
                        sectionContainers.forEach(section => section.style.display = 'none');
                        
                        // إظهار القسم المحدد
                        const sectionId = this.getAttribute('data-section');
                        document.getElementById(`${sectionId}-section`).style.display = 'block';
                    });
                });
                
                // جلب البيانات مباشرة بعد تحميل الصفحة
                if (isClientReady) {
                    window.fetchDashboardData();
                    
                    // تحديث البيانات كل 30 ثانية
                    setInterval(window.fetchDashboardData, 30000);
                } else {
                    // إذا لم يكن الاتصال جاهزًا
                    document.querySelectorAll('.loading-panel').forEach(panel => {
                        panel.innerHTML = `
                            <div style="text-align: center;">
                                <p>واتساب غير متصل</p>
                                <p>يرجى مسح رمز QR أولاً</p>
                                <a href="/api/v1/qr" style="display: inline-block; margin-top: 15px; padding: 10px 20px; background-color: var(--primary-color); color: white; text-decoration: none; border-radius: var(--border-radius);">الذهاب إلى صفحة QR</a>
                            </div>
                        `;
                    });
                }
                
                // تنفيذ التحديث عند النقر على زر التحديث
                document.querySelectorAll('.section-action').forEach(btn => {
                    btn.addEventListener('click', window.fetchDashboardData);
                });
            });
